name: üîÑ Aggiornamento automatico Fastweb Energia (PUN + Offerte)

on:
  schedule:
    - cron: "10 14 * * *"  # ogni giorno alle 14:10 ora italiana
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Imposta TZ
        run: echo "TZ=Europe/Rome" >> $GITHUB_ENV

      - name: üìà Estrai PUN dal GME (best effort)
        run: |
          mkdir -p feed
          # Scarica la pagina indice PUN GME e prova ad estrarre il primo numero "xxx,xx"
          curl -sL "https://www.mercatoelettrico.org/it-it/Home/Pubblicazioni/Indici-GME/PUNIndexGme" \
            | grep -Eo "[0-9]{1,3},[0-9]{1,3}" | head -1 > feed/pun_value.txt || true
          if [ ! -s feed/pun_value.txt ]; then echo "N/D" > feed/pun_value.txt; fi
          echo "PUN: $(cat feed/pun_value.txt)"

      - name: üåê Scarica le pagine Fastweb (sempre fresche)
        run: |
          mkdir -p live
          UA="Mozilla/5.0 (Macintosh; Intel Mac OS X) AppleWebKit/537.36 (KHTML, like Gecko) Chrome Safari"
          # Residenziale
          curl -sL -A "$UA" "https://www.fastweb.it/energia/fastweb-energia-light/" -o "live/flat_light.html" || true
          curl -sL -A "$UA" "https://www.fastweb.it/energia/fastweb-energia-full/"  -o "live/flat_full.html"  || true
          curl -sL -A "$UA" "https://www.fastweb.it/energia/fastweb-energia-maxi/"  -o "live/flat_maxi.html"  || true
          curl -sL -A "$UA" "https://www.fastweb.it/energia/fastweb-energia-flex/"  -o "live/flex_res.html"   || true
          curl -sL -A "$UA" "https://www.fastweb.it/energia/fastweb-energia-fix/"   -o "live/fix_res.html"    || true
          # Business
          curl -sL -A "$UA" "https://www.fastweb.it/energia-aziende/fastweb-energia-business-flex/" -o "live/flex_biz.html" || true
          curl -sL -A "$UA" "https://www.fastweb.it/energia-aziende/fastweb-energia-business-fix/"  -o "live/fix_biz.html"  || true

      - name: üß† Genera pagina riepilogo HTML
        run: |
          NOW=$(date +'%d/%m/%Y %H:%M')
          PUN=$(cat feed/pun_value.txt)

          echo "<html><head><meta charset='utf-8'><title>Listino Fastweb Energia</title><meta name='viewport' content='width=device-width,initial-scale=1'></head><body style='font-family:system-ui,Segoe UI,Roboto,sans-serif;line-height:1.45;padding:16px;'>" > listino_fastweb_view.html
          echo "<h2 style='color:#003366;margin:0'>Listino Fastweb Energia ‚Äì aggiornamento automatico</h2>" >> listino_fastweb_view.html
          echo "<p style='color:#333'>üìÖ Aggiornato: ${NOW} &nbsp;‚Ä¢&nbsp; üîπ PUN riferimento: ${PUN} ‚Ç¨/MWh</p>" >> listino_fastweb_view.html

          echo "<hr><h3 style='color:#003366'>Offerte Business</h3>" >> listino_fastweb_view.html
          cat live/flex_biz.html >> listino_fastweb_view.html || true
          echo "<br/>" >> listino_fastweb_view.html
          cat live/fix_biz.html  >> listino_fastweb_view.html || true

          echo "<hr><h3 style='color:#003366'>Offerte Residenziali</h3>" >> listino_fastweb_view.html
          cat live/flat_light.html >> listino_fastweb_view.html || true
          echo "<br/>" >> listino_fastweb_view.html
          cat live/flat_full.html  >> listino_fastweb_view.html || true
          echo "<br/>" >> listino_fastweb_view.html
          cat live/flat_maxi.html  >> listino_fastweb_view.html || true
          echo "<br/>" >> listino_fastweb_view.html
          cat live/flex_res.html   >> listino_fastweb_view.html || true
          echo "<br/>" >> listino_fastweb_view.html
          cat live/fix_res.html    >> listino_fastweb_view.html || true

          echo "<hr><p style='font-size:12px;color:#666'>Pagina generata automaticamente da GitHub Actions. Fonti: Fastweb.it (business e residenziale) + PUN GME. In caso di temporanea indisponibilit√†, i blocchi corrispondenti potrebbero non aggiornarsi in questo run.</p>" >> listino_fastweb_view.html
          echo "</body></html>" >> listino_fastweb_view.html

      - name: üöÄ Commit & push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add listino_fastweb_view.html feed/pun_value.txt live || true
          git commit -m "üîÑ Auto-update listino $(date +'%d/%m/%Y %H:%M')" || echo "Nessuna modifica"
          git push
